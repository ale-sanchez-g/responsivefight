--- 
    reset_minion: true
    
    language: node_js
    
    node_js:
      - 10.16.3
    # Build Environment
    build_environment: Ubuntu 16.04
    env:
      global:
        - APP_NAME=responsivefight
        - secure: k6/84MShokjmP9Hh1mQ2mtYc6VlXM6tiR0rsFu7FqmsymcwBvlhFqI9vkYKb396YxoqKt9B3qRUzT3HMzjg3IGtr9fpKDGe75QivQguoczsxFJIdf63uwXASGfgmgdBZmkIlfs/u2YefFS5+glKQJMLQCS/EvYNZqBY4ANZLIwHYFfb3S9Qc61D8SjRL9H0SE72nK7yXDsKYR153ap2/ApCp1JdMMX5JYNFhBy2cKS6TZbjIICnIExOAdd7X1J/HvWtVUFcSDKqEZvChcEaLdB1SETGopi0uQgut/40Vyez2WHL/S7Dc3Rf5pwMPZhiOwYm88s+EoqKiv7b7Hj24Cw==    # Create directories for test and coverage reports
    before_script:
      - mkdir -p shippable/testresults
      - mkdir -p shippable/codecoverage

    build:
      pre_ci_boot:
        # https://github.com/cypress-io/cypress-docker-images
        image_name: cypress/browsers
        # use specific tag to avoid surprises
        image_tag: node10.16.3-chrome80-ff73
        pull: true
      ci:
        - chmod u+x version.sh
        - ./version.sh
        - cat app/public/version.json
        - npm install
        - npm start &
        - npm test  
      on_success:
        - chmod u+x heroku.sh
        - rm -rf node_modules
        - npm install --production
        - which heroku || wget -qO- https://cli-assets.heroku.com/install-ubuntu.sh | sh
        - docker build -t registry.heroku.com/$APP_NAME/web .
        - docker push registry.heroku.com/$APP_NAME/web
        - ./heroku.sh
        - heroku container:release -a responsivefight web
        - if [ "$BRANCH" == "master" ]; then git push -f git@heroku.com:$APP_NAME.git master; fi

    integrations:
      hub:
        - integrationName: HerokuRegistry
          type: dockerRegistryLogin